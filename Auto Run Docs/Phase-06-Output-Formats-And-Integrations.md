# Phase 06: Output Formats and Integrations

> **Branch Directive:** All work for this phase MUST be done on the `claude-overhaul` branch. Push commits to `origin/claude-overhaul` only. Do NOT push to `master` or `main`.

This phase adds multiple output formats to make Hamburglar's findings consumable by other tools and workflows. SARIF output enables integration with GitHub Advanced Security and other code scanning tools. CSV enables spreadsheet analysis. The optional database backend allows centralizing findings across multiple scans for trend analysis and reporting.

## Tasks

- [x] Create `src/hamburglar/outputs/sarif.py` with a `SarifOutput` class that: generates SARIF 2.1.0 compliant JSON, maps findings to SARIF result objects, includes rule definitions for each detector, adds file location information with line numbers, includes severity mapping (error/warning/note), adds Hamburglar as the tool driver, validates output against SARIF schema
  - **Completed:** Added `SarifOutput` class with full SARIF 2.1.0 compliance, severity-to-level mapping (CRITICAL/HIGH→error, MEDIUM→warning, LOW/INFO→note), security-severity scores, fingerprints for deduplication, and support for line numbers, columns, and end lines.

- [x] Create `src/hamburglar/outputs/csv_output.py` with a `CsvOutput` class that: generates RFC 4180 compliant CSV, includes headers (file, detector, match, severity, line_number, context), escapes special characters properly, supports configurable delimiter, handles Unicode content correctly
  - **Completed:** Added `CsvOutput` class with full RFC 4180 compliance including CRLF line endings, proper quoting of fields with special characters (commas, newlines, quotes), configurable delimiter (comma by default), optional headers, and full Unicode support including emojis.

- [x] Create `src/hamburglar/outputs/html_output.py` with an `HtmlOutput` class that: generates standalone HTML report, includes summary statistics, groups findings by file and severity, includes collapsible sections for each file, syntax highlights matched content, adds severity color coding, is viewable without external dependencies
  - **Completed:** Added `HtmlOutput` class that generates self-contained HTML reports with inline CSS (no external dependencies). Features include: summary statistics with stat cards (total findings, matches, files affected, files scanned), severity breakdown badges, findings grouped by file with collapsible `<details>` sections, files and findings sorted by severity (critical first), severity color coding with configurable colors, syntax highlighting for matched content in `<code>` blocks, context display in `<pre>` blocks, line number display, XSS prevention via proper HTML escaping, full Unicode support including emojis, responsive design with mobile-friendly CSS, and Hamburglar attribution in footer.

- [x] Create `src/hamburglar/outputs/markdown_output.py` with a `MarkdownOutput` class that: generates GitHub-flavored markdown, includes summary table, uses collapsible details for findings, links to file locations (relative paths), suitable for PR comments or issue creation
  - **Completed:** Added `MarkdownOutput` class that generates GitHub-flavored Markdown reports with: summary table (total findings, matches, files affected, files scanned, duration), severity breakdown table with emoji indicators, collapsible `<details>` sections for grouping findings by file, relative file path links with configurable `base_path`, severity ordering (critical first), line number display, code fences for context, backtick inline code for matches, Markdown character escaping to prevent formatting issues, custom title support, and Hamburglar attribution in footer. Added 72 comprehensive tests achieving 100% code coverage.

- [x] Create `src/hamburglar/storage/__init__.py` with `BaseStorage` abstract class defining: `save_scan(result: ScanResult)`, `get_scans(filter)`, `get_findings(filter)`, `get_statistics()`
  - **Completed:** Added `BaseStorage` abstract class with four abstract methods (`save_scan`, `get_scans`, `get_findings`, `get_statistics`) plus context manager support and `close()` method. Also added: `ScanFilter` and `FindingFilter` dataclasses for query filtering with support for date range, path, severity, detector, pagination (limit/offset); `StoredScan` dataclass wrapping ScanResult with storage metadata (scan_id, stored_at); `ScanStatistics` dataclass for aggregate statistics (totals, breakdowns by severity/detector/date, averages); `StorageError` exception with backend and operation context; `StorageRegistry` for managing storage backend instances; `default_registry` global instance. Added 66 comprehensive tests achieving 95% code coverage.

- [x] Create `src/hamburglar/storage/sqlite.py` with a `SqliteStorage` class that: creates SQLite database with schema (scans, findings, detectors tables), stores scan results with full finding details, supports querying by date range, file path, detector, severity, generates aggregate statistics, handles concurrent access safely
  - **Completed:** Added `SqliteStorage` class implementing the `BaseStorage` interface with full SQLite persistence. Features include: schema with scans, findings, and detectors tables plus indexes for efficient querying; UUID-based scan IDs; JSON serialization of matches, metadata, and stats; filtering by date range (since/until), target path, file path, detector name, severity levels, min/max findings; pagination with limit/offset; aggregate statistics (totals, breakdowns by severity/detector/date, averages); thread-safe concurrent access using thread-local connections and WAL journal mode; context manager support; `get_scan_by_id`, `delete_scan`, and `clear` helper methods; schema versioning for future migrations. Added 91 comprehensive tests achieving full coverage of all functionality.

- [x] Create `src/hamburglar/storage/json_file.py` with a `JsonFileStorage` class that: appends scan results to a JSON lines file, supports reading historical scans, provides simple file-based persistence, useful for CI/CD pipelines
  - **Completed:** Added `JsonFileStorage` class implementing the `BaseStorage` interface with JSON Lines (newline-delimited JSON) file persistence. Features include: appending scan results to a single .jsonl file for streaming and easy parsing; thread-safe writes using file locking (fcntl); reading historical scans with filtering by date range (since/until), target path, file path, detector name, severity levels, min/max findings; pagination with limit/offset; aggregate statistics (totals, breakdowns by severity/detector/date, averages); `get_scan_by_id` and `clear` helper methods; context manager support; full Unicode support including emojis; suitable for CI/CD pipelines where results are appended across multiple runs. Added 92 comprehensive tests covering initialization, save/read operations, filtering, statistics, concurrent access, error handling, edge cases, and CI/CD use cases. 100% test pass rate achieved.

- [x] Update CLI `--format` option to support: json, table, sarif, csv, html, markdown
  - **Completed:** Extended the `OutputFormat` enum to include SARIF, CSV, HTML, and MARKDOWN formats. Added `VALID_FORMATS` mapping for CLI validation, `FORMAT_FORMATTERS` mapping from format to formatter class, and `get_formatter()` helper function. Updated all three CLI commands (scan, scan-git, scan-web) to validate and use all six formats. Updated help text to list all available formats. Structured formats (JSON, SARIF, CSV) are printed directly to preserve formatting, while visual formats (table, HTML, markdown) use Rich console. Added 36 comprehensive tests in `tests/test_cli_formats.py` covering all format options, case-insensitivity, file output, quiet mode, empty directories, and verbose mode. Updated existing tests in `test_cli_errors.py` to reflect newly valid formats.

- [x] Add CLI `--output-dir` option that: saves output to specified directory, auto-names files based on target and timestamp, creates directory if it doesn't exist
  - **Completed:** Added `--output-dir` option to all three CLI commands (scan, scan-git, scan-web). Features include: auto-generated filenames based on target name and timestamp in format `hamburglar_{scan_type}_{target}_{YYYYMMDD_HHMMSS}{extension}`; `FORMAT_EXTENSIONS` mapping for correct file extensions (.json, .sarif.json, .csv, .html, .md, .txt); `generate_output_filename()` helper with smart target name extraction (URL domain for web, repo name for git, directory name for local scans); character sanitization for filesystem safety; nested directory creation; validation that `--output` and `--output-dir` cannot be used together; verbose mode shows generated output file path. Added 34 comprehensive tests in `tests/test_cli_output_dir.py` covering filename generation, directory creation, all format extensions, conflict detection, quiet/verbose modes, and help text.

- [x] Add CLI `--save-to-db` option that: saves findings to SQLite database (default: ~/.hamburglar/findings.db), creates database if it doesn't exist, supports custom database path
  - **Completed:** Added `--save-to-db` and `--db-path` options to all three CLI commands (scan, scan-git, scan-web). Features include: `DEFAULT_DB_PATH` constant set to `~/.hamburglar/findings.db`; `get_db_path()` helper function for resolving custom or default paths; `save_to_database()` helper function that creates database directories if needed, saves scan results using `SqliteStorage`, and provides appropriate console output based on quiet/verbose modes; database and directory creation with proper error handling for `StorageError`, `PermissionError`, and `OSError`; verbose mode displays the scan ID; integration with existing `--output`, `--output-dir`, and format options. Added 29 comprehensive tests in `tests/test_cli_save_to_db.py` covering: default path handling, custom path resolution, database creation, findings storage, quiet/verbose modes, nested directory creation, target path preservation, multiple scan saves, help text verification, database schema verification, and compatibility with output options and all format types. All 3275 project tests pass.

- [x] Create CLI `history` command that: queries stored findings from database, supports filters (--since, --severity, --detector, --path), outputs in any supported format, shows scan statistics over time
  - **Completed:** Added `history` command to CLI that queries stored findings from the SQLite database. Features include: filter options (`--since`/`--until` with ISO dates or relative formats like "7d", "24h", "2w", "1m"; `--severity` for comma-separated severity levels; `--detector` for exact detector name match; `--path` for file path prefix match; `--target` for scan target path prefix match; `--limit` for result count); `--stats` mode for aggregate statistics display with summary table, severity breakdown, detector breakdown (top 10), and recent scan activity (last 7 days); output in all supported formats (json, table, sarif, csv, html, markdown); statistics in JSON and CSV formats for machine consumption; `--output` for file output; `--db-path` for custom database location; `--verbose`/`--quiet` modes; proper exit codes (0=success, 1=error, 2=no findings). Helper functions `parse_severities()` and `parse_date()` for input validation. Added `_display_statistics()` function for formatted statistics output. All output formats work for both findings and statistics modes.

- [ ] Create CLI `report` command that: generates summary report from database, shows most common finding types, shows files with most findings, shows trend over time, outputs as HTML or markdown

- [x] Create `tests/test_sarif_output.py` with tests for: SARIF output is valid JSON, SARIF schema validation passes, findings are correctly mapped, rule definitions are included, file locations are correct
  - **Completed:** Added 52 comprehensive tests covering valid JSON output, schema compliance, findings mapping, rule definitions, file locations, severity mapping, fingerprints, message formatting, and registry integration. 100% code coverage achieved.

- [x] Create `tests/test_csv_output.py` with tests for: CSV is RFC compliant, headers are correct, special characters are escaped, Unicode is handled correctly, delimiter is configurable
  - **Completed:** Added 48 comprehensive tests covering RFC 4180 compliance (CRLF line endings, proper quoting), header inclusion/exclusion, special character escaping, Unicode handling, delimiter configuration, field value extraction, multiple matches handling, empty results, and registry integration. 100% code coverage achieved.

- [x] Create `tests/test_html_output.py` with tests for: HTML is valid and well-formed, summary statistics are included, findings are grouped correctly, no external dependencies required
  - **Completed:** Added 63 comprehensive tests covering: valid HTML structure (DOCTYPE, html/head/body tags, charset, viewport), no external dependencies (no external CSS/JS/fonts), summary statistics (findings count, files scanned, duration, severity breakdown), finding grouping by file with collapsible sections, severity ordering, severity color coding, match highlighting, line number display, XSS prevention (HTML entity escaping), Unicode handling (including emojis), custom title support, BaseOutput interface compliance, OutputRegistry integration, and edge cases (empty matches, missing metadata, long content, many findings). 100% code coverage achieved.

- [x] Create `tests/test_sqlite_storage.py` with tests for: database is created correctly, scans are saved and retrieved, findings can be queried, statistics are accurate, concurrent access works
  - **Completed:** Added 91 comprehensive tests covering: initialization (in-memory and file-based databases, Path object support); schema creation (all tables, indexes, version tracking); save_scan (unique IDs, metadata storage, finding persistence, detector registration); get_scans (filtering by target_path, since/until dates, min/max findings, pagination); get_findings (filtering by file_path, detector_name, severity, target_path, dates, pagination); get_statistics (totals, breakdowns, averages, date tracking); get_scan_by_id and delete_scan methods; context manager support; concurrent access (parallel saves, reads, mixed operations); file persistence and WAL mode; error handling with proper StorageError; registry integration; edge cases (Unicode, large matches, special characters). 100% code coverage achieved.

- [x] Create `tests/test_history_command.py` with tests for: history command works with empty db, filters work correctly, output formats work
  - **Completed:** Added 54 comprehensive tests in `tests/test_history_command.py` covering: `parse_severities()` helper (single/multiple severities, whitespace handling, empty string, invalid severity, case insensitivity); `parse_date()` helper (ISO date, ISO datetime, relative hours/days/weeks/months, invalid format); basic history command (show all findings, no database, empty database, quiet mode, verbose mode); filters (severity single/multiple, detector, path, target, limit, no matches, invalid filters); output formats (json, table, csv, sarif, html, markdown, invalid format, case insensitivity); file output (write to file, quiet mode); statistics mode (summary display, JSON format, CSV format, severity breakdown, detector breakdown, empty database); date filters (relative days, ISO format, since with until); help text (history help, main help includes history); verbose output (filter info, since/until, result count); combined filters (severity+detector, path+severity, all filters). All 3329 tests pass with the new tests.

- [ ] Run pytest and ensure all tests pass with maintained 95%+ coverage
